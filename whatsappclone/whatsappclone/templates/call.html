<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Sesli Arama</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.min.js"></script>
  <style>
    body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; background: #f0f0f0; }
    h1 { margin-bottom: 20px; }
    audio { margin-top: 20px; border: 1px solid #ccc; border-radius: 8px; min-width: 300px; display: block; }
    .call-controls button {
      padding: 12px 20px;
      margin: 8px;
      border-radius: 20px;
      border: none;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s ease;
      box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    }
    #hangupButton {
      background-color: #e74c3c;
      color: white;
    }
    #hangupButton:hover {
      background-color: #c0392b;
    }
    #status {
      margin-top: 15px;
      font-weight: bold;
      color: #333;
      min-height: 20px;
      padding: 5px 10px;
      background-color: #fff;
      border-radius: 5px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      text-align: center;
      max-width: 90%;
    }
    .error-message {
        color: red !important;
        background-color: #ffebee !important;
        border: 1px solid red;
    }
    .info-message {
        color: #007bff;
        background-color: #e7f3ff;
        border: 1px solid #007bff;
    }
  </style>
</head>
<body>
  <h1>ðŸ“ž Sesli Arama</h1>
  <p id="status">BaÄŸlantÄ± bekleniyor...</p>
  <audio id="remoteAudio" autoplay></audio>
  <div class="call-controls" style="margin-top: 20px;">
    <button id="hangupButton" style="display:none;">Ã‡aÄŸrÄ±yÄ± Bitir</button>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get("me");
    const targetId = urlParams.get("to");

    console.log(`Sayfa yÃ¼klendi: userId=${userId}, targetId=${targetId}, action=${urlParams.get('action')}`);

    const socket = io("http://" + location.hostname + ":5000");

    // YENÄ° EKLENDÄ°: TÃ¼m gelen Socket.IO olaylarÄ±nÄ± dinlemek iÃ§in
    if (socket) {
        socket.onAny((eventName, ...args) => {
          console.log(`[SOCKET.IO DEBUG] AlÄ±nan olay: ${eventName}`, args);
        });
        console.log("[SOCKET.IO DEBUG] 'onAny' dinleyicisi kaydedildi.");
    } else {
        console.error("[SOCKET.IO DEBUG] Soket nesnesi tanÄ±msÄ±z, 'onAny' dinleyicisi kaydedilemedi!");
    }


    let pc = null;
    const statusEl = document.getElementById("status");
    const remoteAudio = document.getElementById("remoteAudio");
    const hangupButton = document.getElementById("hangupButton");

    let localStream = null;
    let isCallActive = false;

    function updateStatus(message, type = "info") {
        console.log(`[STATUS] ${type}: ${message}`);
        statusEl.textContent = message;
        statusEl.classList.remove("error-message", "info-message");
        if (type === "error") {
            statusEl.classList.add("error-message");
        } else if (type === "info") {
            statusEl.classList.add("info-message");
        }
    }

    function closeCallResources(notifyPeer = true) {
        console.log("closeCallResources Ã§aÄŸrÄ±ldÄ±. notifyPeer:", notifyPeer);

        if (notifyPeer && isCallActive && targetId && socket.connected) {
            console.log(`Ã‡aÄŸrÄ± bitirme (hangup) sinyali User ${targetId}'ye gÃ¶nderiliyor.`);
            socket.emit("hangup", { to: targetId, from: userId });
        }

        if (localStream) {
            localStream.getTracks().forEach(track => {
                track.stop();
            });
            localStream = null;
            console.log("Lokal medya stream ve track'leri durduruldu.");
        }

        if (pc) {
            console.log("Mevcut PeerConnection kapatÄ±lÄ±yor. Durumu:", pc.signalingState);
            pc.onicecandidate = null;
            pc.oniceconnectionstatechange = null;
            pc.ontrack = null;
            pc.onsignalingstatechange = null;

            if (typeof pc.getTransceivers === "function") {
                pc.getTransceivers().forEach(transceiver => {
                    if (transceiver.stop) {
                        transceiver.stop();
                    }
                });
                 console.log("Transceiver'lar durduruldu.");
            }

            if (pc.signalingState !== "closed") {
                pc.close();
                console.log("RTCPeerConnection.close() Ã§aÄŸrÄ±ldÄ±.");
            }
            pc = null;
            console.log("PeerConnection nesnesi null yapÄ±ldÄ±.");
        }

        if (remoteAudio) {
            remoteAudio.srcObject = null;
            remoteAudio.pause();
            remoteAudio.load();
            console.log("Remote audio elementi sÄ±fÄ±rlandÄ±.");
        }

        isCallActive = false;
        hangupButton.style.display = "none";

        const currentStatus = statusEl.textContent;
        if (!currentStatus.includes("sonlandÄ±rÄ±ldÄ±") && !currentStatus.includes("sonlandÄ±rdÄ±")) {
            updateStatus("Ã‡aÄŸrÄ± sonlandÄ±rÄ±ldÄ±.");
        }
        console.log("Ã‡aÄŸrÄ± sonlandÄ±rma iÅŸlemleri tamamlandÄ±.");
    }

    function initializePeerConnection() {
        console.log("initializePeerConnection Ã§aÄŸrÄ±ldÄ±.");
        if (pc) {
            console.warn("initializePeerConnection: Mevcut bir 'pc' nesnesi bulundu. KapatÄ±lÄ±yor...");
            closeCallResources(false);
        }

        updateStatus("BaÄŸlantÄ± bileÅŸenleri hazÄ±rlanÄ±yor...");
        try {
            pc = new RTCPeerConnection({
              iceServers: [
                { urls: "stun:stun.l.google.com:19302" },
              ]
            });
            console.log("Yeni RTCPeerConnection nesnesi oluÅŸturuldu:", pc);
        } catch (error) {
            console.error("RTCPeerConnection oluÅŸturulamadÄ±:", error);
            updateStatus("HATA: WebRTC baÅŸlatÄ±lamadÄ±. TarayÄ±cÄ±nÄ±z desteklemiyor olabilir.", "error");
            return;
        }

        pc.onicecandidate = ({ candidate }) => {
          if (!pc) { console.warn("onicecandidate: pc is null"); return; }
          if (candidate) {
            console.log("YEREL ICE ADAYI (to:", targetId, "):", candidate);
            socket.emit("ice-candidate", { to: targetId, candidate: candidate, from_user_id: userId });
          } else {
            console.log("TÃ¼m yerel ICE adaylarÄ± toplandÄ±.");
          }
        };

        pc.oniceconnectionstatechange = () => {
          if (!pc) { console.warn("oniceconnectionstatechange: pc is null"); return; }
          console.log("ICE BAÄžLANTI DURUMU DEÄžÄ°ÅžTÄ°:", pc.iceConnectionState);
          switch (pc.iceConnectionState) {
            case "checking":
              updateStatus("BaÄŸlantÄ± kontrol ediliyor...");
              break;
            case "connected":
            case "completed":
              updateStatus("BaÄŸlantÄ± kuruldu! Sesli gÃ¶rÃ¼ÅŸme aktif.");
              isCallActive = true;
              hangupButton.style.display = "inline-block";
              break;
            case "failed":
              updateStatus("BaÄŸlantÄ± kurulamadÄ± (ICE failed).", "error");
              console.error("ICE connection failed. PC state:", JSON.stringify(pc, null, 2));
              closeCallResources();
              break;
            case "disconnected":
              updateStatus("BaÄŸlantÄ± kesildi (ICE disconnected).", "error");
              closeCallResources();
              break;
            case "closed":
              updateStatus("BaÄŸlantÄ± kapatÄ±ldÄ± (ICE closed).");
              closeCallResources(false);
              break;
            default:
              updateStatus(`BaÄŸlantÄ± durumu: ${pc.iceConnectionState}...`);
          }
        };

        pc.ontrack = (event) => {
          if (!pc) { console.warn("ontrack: pc is null"); return; }
          console.log("UZAK MEDYA (SES) TRACK'Ä° ALINDI:", event);
          if (event.streams && event.streams[0]) {
            console.log("Uzak stream remoteAudio elementine atanÄ±yor. Stream:", event.streams[0], "Tracks:", event.streams[0].getTracks());
            if (remoteAudio.srcObject !== event.streams[0]) {
                remoteAudio.srcObject = event.streams[0];
            }
            remoteAudio.play().then(() => {
                console.log("Remote audio baÅŸarÄ±yla oynatÄ±lÄ±yor.");
            }).catch(e => {
                console.error("Remote audio otomatik oynatma hatasÄ±:", e);
                updateStatus("âš ï¸ KarÅŸÄ±dan ses var ama otomatik oynatÄ±lamadÄ±. Sayfaya tÄ±klayÄ±n.", "error");
            });
          } else {
            console.warn("ontrack: Gelen event.streams[0] tanÄ±msÄ±z veya boÅŸ.");
          }
        };

        pc.onsignalingstatechange = () => {
            if (!pc) { console.warn("onsignalingstatechange: pc is null"); return; }
            console.log("SinyalleÅŸme durumu deÄŸiÅŸti:", pc.signalingState);
        };
    }

    socket.on("connect", () => {
      console.log("Socket.IO sunucusuna baÅŸarÄ±yla baÄŸlandÄ±. SID:", socket.id);
      socket.emit("join_private_room", { user_id: userId });
      updateStatus(`Sinyal sunucusuna baÄŸlandÄ±. KullanÄ±cÄ± ID: ${userId}`);
      handleCallLogic();
    });

    socket.on("disconnect", (reason) => {
        console.error("Socket.IO baÄŸlantÄ±sÄ± kesildi:", reason);
        updateStatus("Sinyal sunucusuyla baÄŸlantÄ± kesildi! SayfayÄ± yenileyin.", "error");
        closeCallResources(false);
    });

    function handleCallLogic() {
        if (!userId || !targetId || userId === "null" || targetId === "null" || userId === "undefined" || targetId === "undefined") {
            updateStatus("HATA: GeÃ§erli kullanÄ±cÄ± (me) veya hedef (to) ID'si URL'de doÄŸru ÅŸekilde belirtilmemiÅŸ.", "error");
            console.error(`HatalÄ± veya eksik URL parametreleri: me='${userId}', to='${targetId}'.`);
            return;
        }

        const action = urlParams.get('action');
        console.log(`handleCallLogic: userId=${userId}, targetId=${targetId}, action='${action}'`);

        if (action === 'start') {
             console.log(`KARAR: ARAMA BAÅžLATILACAK. Arayan: ${userId}, Aranan: ${targetId}`);
             startCall();
        } else {
             updateStatus(`KullanÄ±cÄ± ${targetId} ile baÄŸlantÄ± bekleniyor. (Bu taraf aranan)`);
             console.log(`KARAR: ARAMA BEKLENÄ°YOR. Aranan: ${userId}, Arayan olasÄ±: ${targetId}`);
        }
    }

    console.log("DEBUG: 'offer' olayÄ± iÃ§in dinleyici (listener) kaydediliyor.");
    socket.on("offer", async ({ from_user_id, sdp }) => {
      console.log(`[OFFER ALINDI] User ${from_user_id}'den. Mevcut PC:`, pc, "LocalStream:", localStream);
      if (String(from_user_id) === String(userId)) {
          console.warn("Kendi offer'Ä±mÄ±z geldi, dikkate alÄ±nmÄ±yor.");
          return;
      }

      closeCallResources(false);
      initializePeerConnection();

      if (!pc) {
          console.error("[OFFER Ä°ÅžLEME] HATA: PeerConnection baÅŸlatÄ±lamadÄ±.");
          updateStatus("Hata: Arama bileÅŸenleri baÅŸlatÄ±lamadÄ±.", "error");
          return;
      }
      console.log("[OFFER Ä°ÅžLEME] Yeni PC baÅŸlatÄ±ldÄ±:", pc);

      try {
        console.log("[OFFER Ä°ÅžLEME] setRemoteDescription(offer) deneniyor. Gelen SDP:", sdp);
        await pc.setRemoteDescription(new RTCSessionDescription(sdp));
        console.log("[OFFER Ä°ÅžLEME] setRemoteDescription(offer) BAÅžARILI. Sinyal durumu:", pc.signalingState);

        console.log("[OFFER Ä°ÅžLEME] Mikrofon eriÅŸimi isteniyor...");
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
        console.log("[OFFER Ä°ÅžLEME] Mikrofon eriÅŸimi BAÅžARILI. Stream:", localStream, "Tracks:", localStream.getTracks());

        if (!localStream.getTracks().length) {
            console.error("[OFFER Ä°ÅžLEME] HATA: localStream'de hiÃ§ track bulunamadÄ±!");
            updateStatus("HATA: Mikrofon track'leri alÄ±namadÄ±.", "error");
            closeCallResources();
            return;
        }

        localStream.getTracks().forEach(track => {
            console.log(`[OFFER Ä°ÅžLEME] Lokal ses track (${track.kind}, ${track.label}, ${track.id}) RTCPeerConnection'a ekleniyor.`);
            if (pc && typeof pc.addTrack === "function") {
                 const sender = pc.addTrack(track, localStream);
                 console.log(`[OFFER Ä°ÅžLEME] pc.addTrack Ã§aÄŸrÄ±ldÄ±. DÃ¶nen sender:`, sender);
            } else {
                console.error("[OFFER Ä°ÅžLEME] HATA: pc veya pc.addTrack tanÄ±msÄ±z!");
            }
        });
        console.log("[OFFER Ä°ÅžLEME] TÃ¼m lokal track'ler eklendi. PC Senders:", pc.getSenders());


        updateStatus(`User ${from_user_id}'den arama geldi, cevap (answer) oluÅŸturuluyor...`);
        console.log("[OFFER Ä°ÅžLEME] createAnswer() deneniyor. Sinyal durumu:", pc.signalingState);
        const answer = await pc.createAnswer();
        console.log("[OFFER Ä°ÅžLEME] createAnswer() BAÅžARILI. OluÅŸturulan Answer SDP:", answer);

        console.log("[OFFER Ä°ÅžLEME] setLocalDescription(answer) deneniyor.");
        await pc.setLocalDescription(answer);
        console.log("[OFFER Ä°ÅžLEME] setLocalDescription(answer) BAÅžARILI. Sinyal durumu:", pc.signalingState);

        console.log(`[OFFER Ä°ÅžLEME] Cevap (answer) User ${userId}'den User ${from_user_id}'ye gÃ¶nderiliyor.`);
        socket.emit("answer", { to: from_user_id, sdp: pc.localDescription, from_user_id: userId });
        updateStatus("Arama kabul edildi, baÄŸlantÄ± kuruluyor...");
      } catch (err) {
        console.error("[OFFER Ä°ÅžLEME] HATA:", err);
        updateStatus(`âš ï¸ Hata (offer iÅŸleme): ${err.name} - ${err.message}`, "error");
        closeCallResources();
      }
    });

    socket.on("answer", async ({ from_user_id, sdp }) => {
      console.log(`[ANSWER ALINDI] User ${from_user_id}'den. Mevcut PC:`, pc);
      if (!pc) {
          console.warn("[ANSWER Ä°ÅžLEME] Answer alÄ±ndÄ± ama PeerConnection (pc) mevcut deÄŸil. Sinyal durumu:", pc ? pc.signalingState : "PC YOK");
          return;
      }
      console.log("[ANSWER Ä°ÅžLEME] Gelen Answer SDP:", sdp);
      try {
        console.log("[ANSWER Ä°ÅžLEME] setRemoteDescription(answer) deneniyor. Sinyal durumu:", pc.signalingState);
        await pc.setRemoteDescription(new RTCSessionDescription(sdp));
        console.log("[ANSWER Ä°ÅžLEME] setRemoteDescription(answer) BAÅžARILI. Sinyal durumu:", pc.signalingState);
        updateStatus("Cevap alÄ±ndÄ±, baÄŸlantÄ± kuruluyor...");
      } catch (err) {
        console.error("[ANSWER Ä°ÅžLEME] HATA:", err);
        updateStatus(`âš ï¸ Hata (answer iÅŸleme): ${err.name} - ${err.message}`, "error");
        closeCallResources();
      }
    });

    socket.on("ice-candidate", ({ from_user_id, candidate }) => {
      console.log(`[ICE ADAYI ALINDI] User ${from_user_id}'den. Aday:`, candidate, "Mevcut PC:", pc);
      if (!pc) {
          console.warn("[ICE Ä°ÅžLEME] ICE adayÄ± alÄ±ndÄ± ama PeerConnection (pc) mevcut deÄŸil.");
          return;
      }
      if (candidate) {
        pc.addIceCandidate(new RTCIceCandidate(candidate))
          .then(() => console.log("[ICE Ä°ÅžLEME] addIceCandidate BAÅžARILI."))
          .catch(e => {
            console.error("[ICE Ä°ÅžLEME] AlÄ±nan ICE adayÄ± eklenirken HATA:", e);
          });
      } else {
        console.log(`[ICE Ä°ÅžLEME] User ${from_user_id} tÃ¼m ICE adaylarÄ±nÄ± gÃ¶nderdi (null candidate).`);
      }
    });

    async function startCall() {
      console.log(`[STARTCALL] ARAMA BAÅžLATILIYOR: User ${targetId} aranÄ±yor... Mevcut PC:`, pc, "LocalStream:", localStream);
      updateStatus(`KullanÄ±cÄ± ${targetId} aranÄ±yor... (Teklif oluÅŸturuluyor)`);

      closeCallResources(false);
      initializePeerConnection();

      if (!pc) {
          console.error("[STARTCALL] HATA: Arama baÅŸlatÄ±lamadÄ±, PeerConnection baÅŸlatÄ±lamadÄ±.");
          updateStatus("Hata: Arama bileÅŸenleri baÅŸlatÄ±lamadÄ±.", "error");
          return;
      }
      console.log("[STARTCALL] Yeni PC baÅŸlatÄ±ldÄ±:", pc);

      try {
        console.log("[STARTCALL] Mikrofon eriÅŸimi isteniyor...");
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
        console.log("[STARTCALL] Mikrofon eriÅŸimi BAÅžARILI. Stream:", localStream, "Tracks:", localStream.getTracks());

        if (!localStream.getTracks().length) {
            console.error("[STARTCALL] HATA: localStream'de hiÃ§ track bulunamadÄ±!");
            updateStatus("HATA: Mikrofon track'leri alÄ±namadÄ±.", "error");
            closeCallResources();
            return;
        }

        localStream.getTracks().forEach(track => {
            console.log(`[STARTCALL] Lokal ses track (${track.kind}, ${track.label}, ${track.id}) RTCPeerConnection'a ekleniyor.`);
            if (pc && typeof pc.addTrack === "function") {
                const sender = pc.addTrack(track, localStream);
                console.log(`[STARTCALL] pc.addTrack Ã§aÄŸrÄ±ldÄ±. DÃ¶nen sender:`, sender);
            } else {
                 console.error("[STARTCALL] HATA: pc veya pc.addTrack tanÄ±msÄ±z!");
            }
        });
        console.log("[STARTCALL] TÃ¼m lokal track'ler eklendi. PC Senders:", pc.getSenders());

        console.log("[STARTCALL] createOffer() deneniyor. Sinyal durumu:", pc.signalingState);
        const offer = await pc.createOffer();
        console.log("[STARTCALL] createOffer() BAÅžARILI. OluÅŸturulan Offer SDP:", offer);

        console.log("[STARTCALL] setLocalDescription(offer) deneniyor.");
        await pc.setLocalDescription(offer);
        console.log("[STARTCALL] setLocalDescription(offer) BAÅžARILI. Sinyal durumu:", pc.signalingState);

        console.log(`[STARTCALL] Arama teklifi (offer) User ${targetId}'ye gÃ¶nderiliyor.`);
        socket.emit("offer", {
          to: targetId,
          sdp: pc.localDescription,
          from_user_id: userId
        });
        updateStatus("Arama teklifi gÃ¶nderildi. Cevap bekleniyor...");
        hangupButton.style.display = "inline-block";
      } catch (err) {
        console.error("[STARTCALL] HATA:", err);
        let errorMessage = "ðŸŽ™ Mikrofon/Arama baÅŸlatma hatasÄ±: ";
        if (err.name === "NotFoundError" || err.name === "DevicesNotFoundError") {
            errorMessage += "Mikrofon bulunamadÄ± veya eriÅŸim izni verilmedi.";
        } else if (err.name === "NotAllowedError" || err.name === "PermissionDeniedError") {
            errorMessage += "Mikrofon eriÅŸim izni reddedildi.";
        } else {
            errorMessage += `${err.name} - ${err.message}`;
        }
        updateStatus(errorMessage, "error");
        closeCallResources();
      }
    }

    hangupButton.addEventListener("click", () => {
        console.log("KULLANICI TARAFINDAN 'Ã‡aÄŸrÄ±yÄ± Bitir' butonuna tÄ±klandÄ±.");
        updateStatus("Ã‡aÄŸrÄ± sonlandÄ±rÄ±lÄ±yor...");
        closeCallResources(true);
    });

    socket.on("hangup_received", ({ from }) => {
        console.log(`[HANGUP ALINDI] User ${from}'dan. Mevcut PC:`, pc, "isCallActive:", isCallActive);
        if (!pc && !isCallActive) {
            console.log(`hangup_received User ${from}'dan geldi ama aktif Ã§aÄŸrÄ±/pc yok. Dikkate alÄ±nmÄ±yor.`);
            return;
        }
        if ( (targetId && String(from) === String(targetId)) || String(from) === String(userId) ) {
            console.log(`KARÅžI TARAFTAN (User ${from}) Ã§aÄŸrÄ± sonlandÄ±rma (hangup_received) sinyali alÄ±ndÄ±.`);
            updateStatus(`User ${from} Ã§aÄŸrÄ±yÄ± sonlandÄ±rdÄ±.`);
            closeCallResources(false);
        } else {
            console.log(`AlakasÄ±z bir kullanÄ±cÄ±dan (${from}) hangup_received sinyali alÄ±ndÄ±, dikkate alÄ±nmÄ±yor. targetId: ${targetId}`);
        }
    });

    window.addEventListener('beforeunload', (event) => {
        if (isCallActive || pc) {
            console.log("Sayfa kapatÄ±lÄ±yor/yenileniyor, aktif Ã§aÄŸrÄ±/baÄŸlantÄ± sonlandÄ±rÄ±lÄ±yor...");
            closeCallResources(true);
        }
    });

  </script>
</body>
</html>